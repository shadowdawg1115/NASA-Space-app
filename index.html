<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exoplanet Star Chart</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #star-chart {
            width: 600px;
            height: 600px;
            background-color: black;
            margin: auto;
            border: 1px solid #ccc;
        }
        .constellation-line {
            stroke: yellow;
            stroke-width: 2;
        }
    </style>
</head>
<body>
    <h1>Select an Exoplanet</h1>
    <select id="exoplanet-select">
        <option value="" selected disabled>Select an exoplanet</option>
    </select>
    <br><br>

    <!-- Controls for customization -->
    <label for="line-color">Line Color:</label>
    <input type="color" id="line-color" value="#FFFF00">
    <label for="line-width">Line Width:</label>
    <input type="number" id="line-width" value="2" min="1" max="10">
    <br><br>

    <label for="bg-color">Background Color:</label>
    <input type="color" id="bg-color" value="#000000">
    <label for="star-size">Star Size:</label>
    <input type="number" id="star-size" value="3" min="1" max="10">
    <br><br>

    <!-- Buttons for undo/redo, save, and export functionality -->
    <button id="undo-btn">Undo</button>
    <button id="redo-btn">Redo</button>
    <button id="save-btn">Save Constellation</button>
    <button id="export-svg-btn">Export as SVG</button>
    <button id="export-png-btn">Export as PNG</button>
    <br><br>

    <!-- Star chart display area -->
    <div id="star-chart"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        async function fetchExoplanets() {
            try {
                const response = await fetch('/exoplanets');
                const exoplanets = await response.json();
                const select = document.getElementById('exoplanet-select');

                exoplanets.forEach(exoplanet => {
                    const option = document.createElement('option');
                    option.value = exoplanet.name;
                    option.textContent = `${exoplanet.name} (${exoplanet.star})`;
                    select.appendChild(option);
                });

                select.addEventListener('change', (event) => {
                    const exoplanetName = event.target.value;
                    fetchStars(exoplanetName);
                });
            } catch (error) {
                console.error('Error fetching exoplanets:', error);
            }
        }

        async function fetchStars(exoplanet) {
            try {
                const response = await fetch(`/stars/${exoplanet}`);
                const stars = await response.json();

                const width = 600;
                const height = 600;

                const svg = d3.select('#star-chart').html('')
                              .append('svg')
                              .attr('width', width)
                              .attr('height', height)
                              .style('background-color', document.getElementById('bg-color').value);

                const g = svg.append('g');

                const zoom = d3.zoom()
                               .scaleExtent([0.5, 10])
                               .on('zoom', (event) => {
                                   g.attr('transform', event.transform);
                               });

                svg.call(zoom);

                const starSize = document.getElementById('star-size').value;
                const starElements = g.selectAll('circle')
                     .data(stars)
                     .enter()
                     .append('circle')
                     .attr('cx', d => d.right_ascension * 25)
                     .attr('cy', d => height / 2 - d.declination * 3)
                     .attr('r', starSize)
                     .attr('fill', 'white')
                     .on('click', handleStarClick)
                     .append('title')
                     .text(d => d.name);

                let points = [];
                let lines = [];
                let redoStack = [];

                function handleStarClick(event, starData) {
                    const coords = [d3.select(this).attr('cx'), d3.select(this).attr('cy')];
                    points.push(coords);

                    if (points.length > 1) {
                        const lineColor = document.getElementById('line-color').value;
                        const lineWidth = document.getElementById('line-width').value;

                        const line = g.append('line')
                            .attr('x1', points[points.length - 2][0])
                            .attr('y1', points[points.length - 2][1])
                            .attr('x2', points[points.length - 1][0])
                            .attr('y2', points[points.length - 1][1])
                            .attr('class', 'constellation-line')
                            .attr('stroke', lineColor)
                            .attr('stroke-width', lineWidth);

                        lines.push(line);
                        redoStack = [];  // Clear the redo stack on new action
                    }
                }

                // Undo function
                document.getElementById('undo-btn').addEventListener('click', () => {
                    if (lines.length > 0) {
                        const lastLine = lines.pop();
                        redoStack.push(lastLine);
                        lastLine.remove();
                        points.pop();
                    }
                });

                // Redo function
                document.getElementById('redo-btn').addEventListener('click', () => {
                    if (redoStack.length > 0) {
                        const line = redoStack.pop();
                        g.node().appendChild(line.node());
                        lines.push(line);
                        points.push([line.attr('x2'), line.attr('y2')]);  // Restore the last point
                    }
                });

                // Save constellation
                document.getElementById('save-btn').addEventListener('click', () => {
                    if (lines.length > 0) {
                        const constellationName = prompt("Enter a name for your constellation:");
                        if (constellationName) {
                            const constellationData = lines.map(line => ({
                                x1: line.attr('x1'),
                                y1: line.attr('y1'),
                                x2: line.attr('x2'),
                                y2: line.attr('y2')
                            }));

                            // Placeholder for actual save functionality (backend or localStorage)
                            console.log({
                                name: constellationName,
                                data: constellationData
                            });

                            alert(`Constellation "${constellationName}" saved!`);
                        }
                    } else {
                        alert("No lines to save!");
                    }
                });

                // Export as SVG function
                document.getElementById('export-svg-btn').addEventListener('click', () => {
                    try {
                        const svgElement = document.querySelector('#star-chart svg');
                        const serializer = new XMLSerializer();
                        let source = serializer.serializeToString(svgElement);

                        // Add name spaces.
                        if (!source.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)) {
                            source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                        }
                        if (!source.match(/^<svg[^>]+"http:\/\/www\.w3\.org\/1999\/xlink"/)) {
                            source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                        }

                        // Create a file download link
                        const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
                        const downloadLink = document.createElement("a");
                        downloadLink.href = url;
                        downloadLink.download = "constellation_chart.svg";
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);

                        console.log("Export SVG successful");

                    } catch (error) {
                        console.error("Error exporting SVG:", error);
                        alert("Failed to export the image. Please try again.");
                    }
                });

                // Export as PNG function
                document.getElementById('export-png-btn').addEventListener('click', () => {
                    try {
                        const svgElement = document.querySelector('#star-chart svg');
                        const serializer = new XMLSerializer();
                        let source = serializer.serializeToString(svgElement);

                        // Add name spaces.
                        if (!source.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)) {
                            source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                        }
                        if (!source.match(/^<svg[^>]+"http:\/\/www\.w3\.org\/1999\/xlink"/)) {
                            source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                        }

                        const image = new Image();
                        image.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(source);

                        image.onload = function () {
                            const canvas = document.createElement('canvas');
                            canvas.width = 600;
                            canvas.height = 600;
                            const context = canvas.getContext('2d');
                            context.fillStyle = document.getElementById('bg-color').value;
                            context.fillRect(0, 0, canvas.width, canvas.height);
                            context.drawImage(image, 0, 0);

                            const pngUrl = canvas.toDataURL('image/png');
                            const downloadLink = document.createElement('a');
                            downloadLink.href = pngUrl;
                            downloadLink.download = "constellation_chart.png";
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            document.body.removeChild(downloadLink);

                            console.log("Export PNG successful");
                        };

                    } catch (error) {
                        console.error("Error exporting PNG:", error);
                        alert("Failed to export the image. Please try again.");
                    }
                });

            } catch (error) {
                console.error('Error fetching stars:', error);
            }
        }

        fetchExoplanets();
    </script>
</body>
</html>
